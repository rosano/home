{{ $dir := "lyrics" }}
{{ range readDir $dir }}
  {{ $filename := .Name }}
  
  {{ if in (slice "." "_") (substr $filename 0 1) }}
    {{ continue }}
  {{ end }}

  {{ $parts := split (readFile (path.Join $dir $filename)) "---" }}
  
  {{ $params := unmarshal (index $parts 1) }}

  {{ range $i, $v := after 2 $parts }}
    {{ $content := strings.TrimSpace $v }}

    {{ $titleMatch := (index (findRE `^# (.+)` $content) 0) }}
    {{ $title := cond (eq (substr $titleMatch 2 1) "~") (substr $titleMatch 3) (lower (substr $titleMatch 2)) }}
    {{ $content = index (split $content $titleMatch) 1 }}

    {{ $params = merge $params (dict
      "filename" $filename
    ) }}
    
    {{ $headingMatch := (index (findRE `\n(#.+)` $content) 0) }}
    {{ if $headingMatch }}
      {{ $heading := lower (substr $headingMatch 1) }}
      {{ $parts := split $content $headingMatch }}
      {{ $extra := strings.TrimSpace (print $headingMatch (index $parts 1)) }}
      {{ $content = index $parts 0 }}
      
      {{ $params = merge $params (dict
        "extra" (replace $extra "# " "#### ")
      ) }}
    {{ end }}

    {{ $.AddPage (dict
      "content" (dict "mediaType" "text/markdown" "value" (strings.TrimSpace $content))
      "title" $title
      "params" $params
      "kind" "page"
      "weight" (math.Sum $i 1)
      "path" (print (index $params "slug") "/" "n" (printf "%02d" $i))
    ) }}
  {{ end }}
{{ end }}
