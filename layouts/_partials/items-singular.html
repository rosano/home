<div class="post">

{{ $isRSS := eq (.Scratch.Get "kScopeRSS") "true" }}
{{ $isList := eq (.Scratch.Get "kScope") "kScopeList" }}

{{ $dataLink := "" }}
{{ if .Params.link }}{{ $dataLink = .Params.link }}{{ end }}
{{ if .Params.youtube }}{{ $dataLink = print "https://youtu.be/" .Params.youtube }}{{ end }}

{{ if not $isRSS -}}
	{{ with $dataLink }}
	<div class="embed" data-link="{{ . }}"></div>
	{{ end }}
{{- end }}

<!-- CONTENT -->
{{ if $isList -}}<div>{{- else -}}<article>{{- end }}
{{ .Content }}
{{ if $isList -}}</div>{{- else -}}</article>{{- end }}

<!-- RECORDED -->
{{- if .Params.recorded -}}<p><small>Recorded {{ (time.AsTime .Params.recorded).Format "Jan 2006" }}.</small></p>{{- end -}}

<!-- SERIES -->
{{- range (.GetTerms "series") -}}<small>Part of <a href="{{ .Permalink }}">{{ .Title }}</a>.</small>{{- end -}}

<!-- TAGS -->
{{- with .GetTerms "tags" -}}
<small>Tagged: {{ range $index, $element := . -}}
	{{- if $index }}, {{ end }}<a href="{{ .Permalink }}">{{ .Title }}</a>
{{- end -}}.
</small>
{{ end }}

<span class="metadata">
	{{ $departure := index (last 1 (where (.Site.Store.Get "kDepartures") "time" "le" .Date)) 0 }}

	<small>
		<!-- TIMESTAMP -->
		{{ $t := .Date | time.In $departure.timezone }}
		{{ $hideTime := eq (substr (.Date.Format "2006-01-02T15:04:05.000Z") -13) "12:00:00.000Z" }}
		<a aria-label="Permalink for {{ cond $hideTime "" (print ($t | time.Format ":time_short") ", ") }}{{ $t | time.Format ":date_long" }}" href="{{ .Permalink }}"><time datetime="{{ $t.Format "2006-01-02T15:04:05Z07:00" }}">{{ if $isList -}}
			{{- $t.Format "15h04" -}}
		{{- else -}}
			{{- $t.Format (print "Jan 02 2006" (cond $hideTime "" ", 15h04")) -}}
		{{- end }}</time></a>

		<!-- PLACE -->
		{{ range $key, $val := .Site.Taxonomies.place }}
			{{ if eq .Page.LinkTitle $departure.place }}
				<span>from <a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a> / </span>
			{{ end }}
		{{ end}}

		<!-- COUNTRY -->
		{{ range $key, $val := .Site.Taxonomies.country }}
			{{ if eq .Page.LinkTitle $departure.country }}
				<span><a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a></span>
			{{- end -}}
		{{- end -}}

		<!-- VIA -->
		{{- with .Param "via" -}}
		<span>, via: </span> 
		<span>{{- if strings.Contains . "http" }}<a href="{{ . }}">{{ replace (urls.Parse .).Hostname "www." "" }}</a>{{ else }}{{ . }}{{ end }}</span>
		{{ end }}
	</small>

<!-- TYPES -->
{{ with .GetTerms "categories" }}
	{{ if $isRSS }}<small>, type: {{ end -}}
	<span class="types">
		{{- range . -}}<a href="{{ .Permalink }}">{{ .Title }}</a> {{ end -}}
	</span>
	{{- if $isRSS }}</small>{{end}}
{{ end }}
</span>

{{ if (and .Params.around (not $isList)) }}
	{{ $around := time .Params.around }}
	{{ $departure := index (last 1 (where (.Site.Store.Get "kDepartures") "time" "le" $around)) 0 }}
	<small>
		Recorded 

		<!-- PLACE -->
		{{ range $key, $val := .Site.Taxonomies.place }}
			{{ if eq .Page.LinkTitle $departure.place }}
				<span>in <a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a> / </span>
			{{ end }}
		{{ end}}

		<!-- COUNTRY -->
		{{ range $key, $val := .Site.Taxonomies.country }}
			{{ if eq .Page.LinkTitle $departure.country }}
				<span><a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a></span>
			{{- end -}}
		{{- end -}}

		<!-- TIMESTAMP -->
		{{ $t := $around | time.In $departure.timezone }}
		around <time datetime="{{ $t.Format "2006-01-02T15:04:05Z07:00" }}">{{- $t.Format "Jan 2006" -}}</time></a>.
	</small>
{{ end }}

<!-- IMPROVE -->
{{ if (and (not $isList) (not $isRSS)) -}}
<hr>

<small class="metadata">
	<span>
		<a href="https://github.com/rosano/home/edit/master{{ replace (print "/content/" .Page.File.Path) "/content/timeline/_content.gotmpl" (print (replace .Path "/timeline" "/journal") ".md") }}">Source</a>
	</span>
</small>
{{- end }}

</div>
