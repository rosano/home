<div class="post">

{{- $isRSS := .Scratch.Get "kScopeRSS" -}}
{{- $isList := .Scratch.Get "kScopeList" -}}

{{- $dataLink := "" -}}
{{- if .Params.link }}{{ $dataLink = .Params.link }}{{ end -}}
{{- if .Params.youtube_id }}{{ $dataLink = print "https://youtu.be/" .Params.youtube_id }}{{ end -}}

{{- if not $isRSS -}}
	{{- with $dataLink -}}
		<div class="embed" data-link="{{ . }}"></div>
	{{- end -}}
{{- end }}

<!-- FEATURE IMAGE -->
{{- if .Params.feature_image -}}
	<div class="feature-image">{{ print "![](" .Params.feature_image ")" | markdownify | safeHTML }}</div>
{{- end -}}

<!-- TITLE -->
{{- if and (not $isRSS) .Title (ne .Layout "single") -}}
	<h3 class="title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
{{- end -}}

<!-- NUGGET -->
{{- if .Params.Summary -}}
	<div class="nugget">{{ .Summary | markdownify | safeHTML }}</div>
	{{- if $isRSS -}}<hr>{{- end }}
{{- end -}}

<!-- CONTENT -->
{{ if $isList -}}<div class="content">{{- else -}}<article class="content">{{- end }}
{{- $Content := .Content -}}

{{- /* 
//   via https://discourse.gohugo.io/t/making-replacere-substitutions-lowercase-for-an-implementation-of-wikilinks/35793/2
*/ -}}
{{- range (findRE `\[{2}(?U:.+)\]{2}` $Content) -}}
  {{- $title := trim . "[ ]" -}}
  {{- $match := index (where site.Pages "Title" $title) 0 -}}
  {{ if $match }}
  	{{- $link := printf `<a href="%s">%s</a>` $match.RelPermalink $title -}}
  	{{- $Content = replace $Content . $link 1 -}}
  {{ end }}
{{- end -}}

{{- $linkRE := `\[(.+)\]\((.+)\)` -}}
{{- range (findRE $linkRE $Content) -}}
  {{- $text := replaceRE $linkRE "$1" . -}}
  {{- $match := index (where site.Pages "Title" (replaceRE $linkRE "$2" .)) 0 -}}
  {{ if $match }}
  	{{- $link := printf `<a href="%s">%s</a>` $match.RelPermalink $text -}}
  	{{- $Content = replace $Content . $link 1 -}}
  {{ end }}
{{- end -}}

{{- $Content | safeHTML -}}

<!-- RELATED -->
{{- if .Params.related -}}
	<hr>
	<p><small>{{ .Params.related | markdownify | safeHTML }}</small></p>
	<hr>
{{- end -}}

{{- if $isList }}</div>{{ else }}</article>{{ end -}}

<!-- LYRICS -->
{{- if not $isList -}}
	{{- if .Params.lyrics -}}
		{{- with site.GetPage (print "lyrics/" .Params.lyrics) -}}
			<h4><a href="{{ .RelPermalink }}">lyrics</a></h4>
		  <blockquote class="lyrics">
		  {{- .Content -}}
		  </blockquote>
		{{- end -}}
	{{- end -}}
{{- end }}

{{- partial "shared-meta.html" . -}}

</div>
