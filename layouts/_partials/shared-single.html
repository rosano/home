<div class="post">

{{- $isRSS := .Scratch.Get "kScopeRSS" -}}
{{- $isList := .Scratch.Get "kScopeList" -}}

{{- $dataLink := "" -}}
{{- if .Params.link }}{{ $dataLink = .Params.link }}{{ end -}}
{{- if .Params.youtube_id }}{{ $dataLink = print "https://youtu.be/" .Params.youtube_id }}{{ end -}}

{{- if not $isRSS -}}
	{{- with $dataLink -}}
		<div class="embed" data-link="{{ . }}"></div>
	{{- end -}}
{{- end }}

<!-- FEATURE IMAGE -->
{{- if .Params.feature_image -}}
	<div class="feature-image">{{ print "![](" .Params.feature_image ")" | markdownify | safeHTML }}</div>
{{- end -}}

<!-- TITLE -->
{{- if and (not $isRSS) .Title (ne .Layout "single") -}}
	<h3 class="title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
{{- end -}}

<!-- NUGGET -->
{{- if .Params.Summary -}}
	<div class="nugget">{{ .Summary | markdownify | safeHTML }}</div>
	{{- if $isRSS -}}<hr>{{- end }}
{{- end -}}

<!-- CONTENT -->
{{ if $isList -}}<div class="content">{{- else -}}<article class="content">{{- end }}
{{- $Content := .Content -}}

{{- /* 
//   via https://discourse.gohugo.io/t/making-replacere-substitutions-lowercase-for-an-implementation-of-wikilinks/35793/2
*/ -}}
{{- range (findRE `\[{2}(?U:.+)\]{2}` $Content) -}}
  {{- $title := trim . "[ ]" -}}
  {{- $match := index (where site.Pages "Title" $title) 0 -}}
  {{ if $match }}
  	{{- $link := printf `<a href="%s">%s</a>` $match.RelPermalink $title -}}
  	{{- $Content = replace $Content . $link 1 -}}
  {{ end }}
{{- end -}}

{{- $linkRE := `\[(.+)\]\((.+)\)` -}}
{{- range (findRE $linkRE $Content) -}}
  {{- $text := replaceRE $linkRE "$1" . -}}
  {{- $match := index (where site.Pages "Title" (replaceRE $linkRE "$2" .)) 0 -}}
  {{ if $match }}
  	{{- $link := printf `<a href="%s">%s</a>` $match.RelPermalink $text -}}
  	{{- $Content = replace $Content . $link 1 -}}
  {{ end }}
{{- end -}}

{{- $Content | safeHTML -}}

<!-- RELATED -->
{{- if .Params.related -}}
	<hr>
	<p><small>{{ .Params.related | markdownify | safeHTML }}</small></p>
	<hr>
{{- end -}}

{{- if $isList }}</div>{{ else }}</article>{{ end -}}

<!-- LYRICS -->
{{- if not $isList -}}
	{{- if .Params.lyrics -}}
		{{- with site.GetPage (print "lyrics/" .Params.lyrics) -}}
			<h4><a href="{{ .RelPermalink }}">lyrics</a></h4>
		  <blockquote class="lyrics">
		  {{- .Content -}}
		  </blockquote>
		{{- end -}}
	{{- end -}}
{{- end }}

<!-- RECORDED -->
{{- if .Params.recorded -}}<p><small>Recorded {{ (time.AsTime .Params.recorded).Format "Jan 2006" }}.</small></p>{{- end -}}

<!-- SERIES -->
{{- range (.GetTerms "series") -}}<small>Part of <a href="{{ .RelPermalink }}">{{ .Title }}</a>.</small>{{- end -}}

<!-- TAGS -->
{{- with .GetTerms "tags" -}}
<p>
	<small>Tagged: {{ range $index, $element := . -}}
		{{- if $index }}, {{ end }}<a href="{{ .RelPermalink }}">{{ .Title }}</a>
	{{- end }}.
	</small>
</p>
{{- end }}

{{ if .Date }}

<span class="metadata">
	{{- $departure := partial "func/departures-closest" .Date }}

	<small>
		<!-- TIMESTAMP -->
		{{- $t := .Date | time.In $departure.timezone -}}
		{{- $hideTime := eq (substr ((.Date | time.In "UTC").Format "2006-01-02T15:04:05.000Z") -13) "12:00:00.000Z" -}}
		<a aria-label="Permalink for {{ cond $hideTime "" (print ($t | time.Format ":time_short") ", ") }}{{ $t | time.Format ":date_long" }}" href="{{ .RelPermalink }}"><time datetime="{{ $t.Format "2006-01-02T15:04:05Z07:00" }}">{{ if $isList -}}
			{{- $t.Format "15h04" -}}
		{{- else -}}
			{{- $t.Format (print "Jan 02 2006" (cond $hideTime "" ", 15h04")) -}}
		{{- end }}</time></a>

		<!-- PLACE -->
		{{ range site.Taxonomies.place -}}
			{{- if eq .Page.LinkTitle $departure.place -}}
				<span>from <a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a> / </span>
			{{- end -}}
		{{- end}}

		<!-- COUNTRY -->
		{{- range site.Taxonomies.country -}}
			{{- if eq .Page.LinkTitle $departure.country -}}
				<span><a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a></span>
			{{- end -}}
		{{- end -}}

		<!-- VIA -->
		{{- with .Param "via" -}}
		<span>, via: 
			{{ if strings.Contains . "http" -}}
				<a href="{{ . }}">{{ replace (urls.Parse .).Hostname "www." "" }}</a>
			{{- else -}}
				{{- . -}}
			{{- end -}}
		</span>
		{{- end -}}

		<!-- TYPES -->
		{{- if $isRSS -}}
			{{- with .GetTerms "categories" -}}
				<span>, type: {{- range . -}}<a href="{{ .RelPermalink }}">{{ .Title }}</a>{{ end -}}</span>
			{{- end -}}
		{{- end -}}
	</small>

<!-- TYPES -->
{{- if not $isRSS -}}
	{{- with .GetTerms "categories" -}}
		<span class="types">
			{{- range . -}}<a href="{{ .RelPermalink }}">{{ .Title }}</a> {{ end -}}
		</span>
	{{- end -}}
{{- end -}}
</span>

{{- if (and .Params.around (not $isList)) }}
	{{ $around := time .Params.around }}
	{{ $departure := partial "func/departures-closest" $around }}
	<small>
		Recorded 

		<!-- PLACE -->
		{{ range site.Taxonomies.place }}
			{{ if eq .Page.LinkTitle $departure.place }}
				<span>in <a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a> / </span>
			{{ end }}
		{{ end}}

		<!-- COUNTRY -->
		{{ range site.Taxonomies.country }}
			{{ if eq .Page.LinkTitle $departure.country }}
				<span><a href="{{ .Page.RelPermalink }}">{{ .Page.LinkTitle }}</a></span>
			{{- end -}}
		{{- end -}}

		<!-- TIMESTAMP -->
		{{ $t := $around | time.In $departure.timezone }}
		around <time datetime="{{ $t.Format "2006-01-02T15:04:05Z07:00" }}">{{- $t.Format "Jan 2006" -}}</time></a>.
	</small>
{{- end -}}

<!-- SOURCE -->
{{- if (and (not $isList) (not $isRSS)) -}}
<hr>

<small class="external">
	{{ if site.Params.sourcePrefix -}}
		<span>
			<a href="{{ site.Params.sourcePrefix }}{{ replace (print "/content/" .Page.File.Path) "/content/timeline/_content.gotmpl" (print "/content-sources/journal/" .Page.Params.originalBasename ".md") }}">Source</a>
		</span>
	{{- end }}
	{{- $syndications := slice
		(dict
			"key" "youtube_id"
			"title" "YouTube"
			"prefix" "https://youtu.be/")
		(dict
			"key" "mastodon_id"
			"title" "Mastodon"
			"prefix" "https://mastodon.online/@rosano/")
		(dict
			"key" "bluesky_id"
			"title" "Bluesky"
			"prefix" "https://bsky.app/profile/rosano.ca/post/")
		(dict
			"key" "twitter_id"
			"title" "Twitter"
			"prefix" "https://twitter.com/rosano/status/")
		(dict
			"key" "facebook_id"
			"title" "Facebook"
			"prefix" "https://facebook.com/")
		(dict
			"key" "nostr_id"
			"title" "Nostr"
			"prefix" "https://njump.me/")
		(dict
			"key" "threads_id"
			"title" "Threads"
			"prefix" "https://www.threads.net/@rosano/post/")
		(dict
			"key" "instagram_id"
			"title" "Instagram"
			"prefix" "https://instagram.com/rosano/p/")
		(dict
			"key" "tiktok_id"
			"title" "TikTok"
			"prefix" "https://www.tiktok.com/@rosano.ca/video/")
	-}}

	{{- $params := .Params -}}
	{{- $existing := slice -}}

	{{- range $syndications -}}
		{{- if index $params (index . "key") -}}
			{{- $existing = $existing | append . -}}
		{{- end -}}
	{{- end -}}

	<span>
		{{- if len $existing -}}
			Also on 
			{{ range $existing }}
				{{- $id := index $params (index . "key") -}}
				<a href="{{ print (index . "prefix") $id }}">{{ index . "title" }}</a>				
			{{ end -}}
		{{- end -}}
	</span>
</small>
{{- end }}
	
{{ end }}

</div>
